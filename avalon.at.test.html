<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="avalon.js"></script>
        <script src="mocha/mocha.js"></script>
        <link href="mocha/mocha.css" rel="stylesheet" type="text/css" />
        <script src="mocha/expect.js"></script>
        <script>
            function fireKeyUp(elem, keyCode) {
                //https://gist.github.com/termi/4654819
                var customEvent
                try {
                    // FF
                    customEvent = document.createEvent("KeyEvents")//firefox 
                    customEvent.initKeyEvent("keyup", true, true, document.defaultView, true, true, true, true, keyCode, 0);
                } catch (ex) {
                    try {
                        //https://github.com/termi/DOM-Keyboard-Event-Level-3-polyfill
                        customEvent = new KeyboardEvent("keyup", {key: keyCode + ""})//DOM4
                    } catch (ex2) {
                        //http://stackoverflow.com/questions/10455626/keydown-simulation-in-chrome-fires-normally-but-not-the-correct-key
                        try {
                            customEvent = document.createEvent("KeyboardEvent")
                            customEvent.initKeyboardEvent("keyup", true, true, document.defaultView,
                                    true, true, true, true, keyCode, 0)
                        } catch (ex3) {
                        }
                    }
                }
                if (customEvent) {
                    elem.dispatchEvent(customEvent)
                } else if (document.createEventObject) {
                    //http://stackoverflow.com/questions/7518664/how-can-i-generate-a-keyup-event-with-a-specific-keycode-in-ie8
                    customEvent = document.createEventObject("KeyboardEvent");
                    customEvent.keyCode = keyCode;
                    elem.fireEvent("onkeyup", customEvent);
                }
            }
            require(["avalon.at"], function() {
                mocha.ui('bdd')
                mocha.setup({timeout: 100000})
                avalon.define("test", function(vm) {
                    vm.at = {
                        datalist: ["aaa", "aab", "aaaa", "aac", "ccc", "cc1", "ccaaccaa"],
                        minLength: 0
                    }
                    vm.$skipArray = ["at"]
                })
                avalon.scan()
                describe('测试@组件', function(done) {
                    console.log(done)
                    it("async", function() {
                        var elem = document.getElementById("test")
                        elem.value = "xxx@"

                        setTimeout(function() {
                            fireKeyUp(elem, 11)
                          //  done()
                        }, 100)

                    })

                })
                mocha.run()

            })
        </script>
    </head>
    <body>
        <p>mocha 在浏览器的测试文档见<a href="http://visionmedia.github.io/mocha/#browser-support">这里</a></p>
        <div><input ms-controller="test" ms-widget="at,at1" id="test"></div>
        <div id="mocha"></div>
    </body>
</html>
