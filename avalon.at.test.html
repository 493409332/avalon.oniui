<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link href="mocha/mocha.css" rel="stylesheet" type="text/css" />
        <script src="avalon.js"></script>
        <script src="mocha/jquery.js"></script>
        <script src="mocha/mocha.js"></script>
        <script src="mocha/expect.js"></script>
        <script>
            function fireKeyUp(elem, keyCode) {
                //https://gist.github.com/termi/4654819
                var customEvent
                try {
                    // FF
                    customEvent = document.createEvent("KeyEvents")//firefox 
                    customEvent.initKeyEvent("keyup", true, true, document.defaultView, false, false, false, false, keyCode, 0)
                    console.log("firefox success")
                } catch (ex) {
                    //http://stackoverflow.com/questions/10455626/keydown-simulation-in-chrome-fires-normally-but-not-the-correct-key
//                    try {
//                        customEvent = new KeyboardEvent("keypress", {"key": keyCode})
//                        console.log(customEvent)
//                    } catch (e) {
                        try {
                            //http://www.w3.org/TR/DOM-Level-3-Events/#idl-interface-KeyboardEvent-initializers
                            customEvent = document.createEvent("KeyboardEvent")
                            customEvent.initKeyboardEvent("keyup", true, true, document.defaultView,false, false, false, false, keyCode,keyCode )
                            console.log("which " + customEvent.which)
                        } catch (ex3) {
                        }
                //    }


                }
                if (customEvent) {
                    // customEvent.keyCode = keyCode;
                    elem.dispatchEvent(customEvent)
                } else if (document.createEventObject) {
                    //http://stackoverflow.com/questions/7518664/how-can-i-generate-a-keyup-event-with-a-specific-keycode-in-ie8
                    customEvent = document.createEventObject("KeyboardEvent");
                    customEvent.keyCode = keyCode;
                    elem.fireEvent("onkeyup", customEvent);
                }
            }
            require(["avalon.at"], function() {
                mocha.ui('bdd')
                mocha.setup({timeout: 100000})
                avalon.define("test", function(vm) {
                    vm.at = {
                        datalist: ["aaa", "aab", "aaaa", "aac", "ccc", "cc1", "ccaaccaa"],
                        minLength: 0
                    }
                    vm.$skipArray = ["at"]
                })
                avalon.scan()
                describe('测试@组件', function() {
                    it("async", function(done) {
                        var elem = document.getElementById("test")
                        elem.value = "xxx@a"
                        elem.focus()
                        setTimeout(function() {
                            fireKeyUp(elem, 11)
                            expect($(".ui-at-item.hover").index()).to.be(0)
                            setTimeout(function() {
                                elem.focus()
                                fireKeyUp(elem, 40)
                            }, 1000)

                            done()
                        }, 100)

                    })

                })
                mocha.run()

            })


        </script>
    </head>
    <body>
        <p>mocha 在浏览器的测试文档见<a href="http://visionmedia.github.io/mocha/#browser-support">这里</a></p>
        <div><input ms-controller="test" ms-widget="at,at1" id="test"></div>
        <div id="mocha"></div>
        <pre>
dictionary KeyboardEventInit {
    boolean       bubbles = false;
    boolean       cancelable = false;
    AbstractView? view = null;
    long          detail = 0;
    DOMString     key = "";
    unsigned long location = 0;
    boolean       ctrlKey = false;
    boolean       shiftKey = false;
    boolean       altKey = false;
    boolean       metaKey = false;
    boolean       repeat = false;
    unsigned long charCode = 0;
    unsigned long keyCode = 0;
    unsigned long which = 0;
};
        </pre>
    </body>
</html>
