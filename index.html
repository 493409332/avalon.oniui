<!DOCTYPE html>
<html>
    <head>
        <title>目录</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link type="text/css" rel="stylesheet" href="./style/avalon.doc.css" />
        <link type="text/css" rel="stylesheet" href="./style/avalon.index.css" />
        <script src="avalon.js"></script>
        <script src="./highlight/shCore.js"></script>
    </head>
    <body>
        <div class="header">
            <div class="nav">
                <ul>
                    <li class="active">组件库</li>
                    <li>字体图标</li>
                </ul>
                <div class="search">
                    <input type="text"/>
                </div>
            </div>
            <h1><span>Avalon新一代UI库： OniUI</span></h1>
        </div>
        <div class="content ms-controller" ms-css-min-height="{{uiListHeight}}" ms-controller ="avalonUiDocument">
            <ul class="ui-list">
                <li ms-repeat="widgets" data-repeat-rendered="uiListRendered"><a href="#" ms-class="active: $index===currentIndex" ms-click="showDocument(el, $event, $index)">{{el}}</a></li> 
            </ul>
            {{renderIframe() | html}}
            <iframe ms-if="!hashchangeSupport" id="doccanvas" scrolling="no" name="doccanvas" class="ui-doc" style="width:760px;" ms-on-load="setHeight" frameborder="none" ms-attr-src="href"></iframe>
        </div>
        <div class="footer">
            <ul>
                <li><a href="#">关于AvalonUI</a></li>
                <li><a href="#">联系我们</a></li>
                <li><a href="#">业务合作</a></li>
                <li><a href="#">常见问题</a></li>
                <li class="last"><a href="#">友情链接</a></li>
            </ul>
        </div>
        <script>
avalon.ready(function() {
    var docCssReg = /<link[^>]*style\/avalon\.doc\.css[^>]*\>/img,
            widgets = ["accordion", "tab", "spinner", "slider", "textbox", "dropdown", "datepicker", "dialog", "at", "button", "checkboxlist", "cookie", "draggable", "flipswitch", "hotkeys", "json", "miniswitch", "notice", "pager", "position", "preview", "progressbar", "resizable", "roleselect", "scrollbar", "scrollspy", "simplegrid", "store", "switchdropdown", "tooltip"].sort();
    var defaultHref = "accordion/avalon.accordion.doc.html";
    function getHref(urlHash) {
        var hash = (urlHash || location.hash).match(/avalon[\S]+\.html/g) || "";
        if(hash) {
            hash = hash[0].split(".")[1] + "/" + hash[0]
        }
        return hash
    }
    function setHash(hash) {
        if(!hash.match(/^#/g)) hash = "#" + defaultHref.split("/")[1]
        location.hash = hash
    }
    var oldHref, vmodel = avalon.define("avalonUiDocument", function(vm) {
        vm.widgets = widgets;
        vm.href = getHref() || defaultHref;
        vm.currentIndex = 0;
        vm.uiListHeight = 0;
        vm.hashchangeSupport = !navigator.userAgent.match(/MSIE [5-7]/);
        vm.timer = "";
        vm.showDocument = function(widget, event, index) {
            event.preventDefault();
            if(!vmodel.hashchangeSupport) {
                vmodel.href = widget + "/avalon." + widget + ".doc.html";
            }
            setHash("#avalon." + widget + ".doc.html");
            vmodel.currentIndex = index;
        };
        vm.afterTemplateLoaded = function(template) {
            template = template.replace(docCssReg, "");
            return template;
        };
        vm.uiListRendered = function() {
            vmodel.uiListHeight = avalon(this).height();
        }
        vm.adjustLinks = function() {
            if (document.querySelectorAll) {
                Array.prototype.forEach.call(document.querySelectorAll(".wrapper .example-links li a"), function(link) {
                    var href = link.getAttribute("href")
                    var match = href.match(/avalon\.([^.]+)/) || ["", ""]

                    link.href = "#" + href
                    link.target = ""
                    link.onclick = function() {
                        vmodel.href = match[1] + "/" + href
                    }
                })
            }
            if (window.SyntaxHighlighter) {
                SyntaxHighlighter.highlight()
            }
        }
        vm.renderIframe = function() {
            if(!vmodel.hashchangeSupport) return "";
            return '<iframe id="doccanvas" scrolling="no" name="doccanvas" class="ui-doc" style="width:760px;" frameborder="none" src="' + vmodel.href + '"></iframe>'
        }
        vm.setHeight = function() {
            clearInterval(vm.timer);
            var counter = 0;
            // 扫描，修改高度
            vmodel.timer = setInterval(function() {
                var iframe = document.getElementById("doccanvas")
                var nwindow = iframe.contentWindow
                if(nwindow.document && nwindow.document.getElementsByTagName("body")[0]) {
                    nwindow = nwindow.document
                    try{
                        h = avalon(nwindow.body).outerHeight() + avalon(nwindow.body).offset().top;
                        avalon(iframe).css("height", h + "px");
                        counter++;
                        if(counter > 50) clearInterval(vmodel.timer)
                        if(oldHref !== nwindow.location.href) {
                            oldHref = nwindow.location.href
                            if(!oldHref.match(/avalon\.[\S]+\.doc\./g)) return;
                            // 把iframe的src同步到父页面hash
                            if(!vmodel.hashchangeSupport) {
                                var h = oldHref.split("/")
                                setHash("#" + h[h.length - 1]);
                            }
                            var ols = nwindow.getElementsByTagName("ol");
                            if(!ols.length) ols = nwindow.getElementsByTagName("ul");
                            for(var i = 0, len = ols.length; i < len; i++) {
                                if(!ols[i].className.match(/example\-lists|example\-links/g)) continue;
                                var as = ols[i].getElementsByTagName("a")
                                avalon.each(as, function(x, item) {
                                    item.onclick= function(e) {
                                        var e = e || iframe.contentWindow.event;
                                        e.preventDefault && e.preventDefault();
                                        e.returnValue = false;
                                        var h = item.getAttribute("href").split("/");
                                        h = h[h.length - 1];
                                        setHash("#" + (h.match(/avalon[\S]+\.html/g) || []).join(""));
                                        if(!vmodel.hashchangeSupport) {
                                            vmodel.href = h.split(".")[1] + "/" + h
;                                        }
                                    }
                                })
                            }
                        }
                    }catch(e) {
                        clearInterval(vmodel.timer)
                    }
                }
            }, 100)
        }
    })
    avalon.scan();
    if(vmodel.hashchangeSupport) {
        vmodel.setHeight();
        window.onhashchange = function(e) {
            var hash = location.hash.split("#")[1];
            hash = hash || defaultHref.split("/")[1];
            vmodel.href = getHref(hash)
            vmodel.setHeight()
        }
    }
})
        </script>
    </body>
</html>
