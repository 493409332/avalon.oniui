<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多图上传（微博）</title>
<script src="../avalon.js"></script>
<style>
ul{
	margin: 0;
	padding: 0;
}
li{
	list-style: none;
}

.imguploader{
	overflow: hidden;
}
	.imguploader li{
		float: left;
		margin-right: 5px;
		margin-bottom: 5px;
		cursor: pointer;
		width: 100px;
		height: 100px;
		box-sizing: border-box;
	}
	.preview{
		background: no-repeat center center;
		background-size: cover;
	}
	.imguploader .add{
		border: 2px dashed #ccc;
		position: relative;
		text-align: center;
		overflow: hidden;
		*width: 96px;
		*height: 96px;
	}
	.imguploader .add:hover{
		border-color: #FFA306;
	}
		.imguploader .add input{
			font-size: 100px;
			position: absolute;
			right: 0px;
			bottom: 0px;
			cursor: pointer;
			opacity: 0;
			filter: alpha(opacity=0);
		}
		.imguploader .add .icon-add{
			font-size: 40px;
			line-height: 98px;
			color: #ccc;
		}

/* test */
	.test .preview{
		height: 100px;
		width: 100px;
		background-image: url(img/4.jpg);
		filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='img/4.jpg', sizingMethod='scale');
	}
			
</style>
</head>
<body ms-controller="test">
	
	<h2>多图片上传（仿新浪微博）</h2>
	<p>支持chrome, firefox, ie10+</p>
	<p>共{{fileSrcList.length}}张，还能上传{{max - fileSrcList.length}}张</p>

	<form action="post.php" method="post">
		<ul class="imguploader">
			<li class="preview" ms-repeat="fileSrcList" ms-click="removeFile($index)" ms-css-background-image="'url(' + el + ')'" ms-css-filter="'progid:DXImageTransform.Microsoft.AlphaImageLoader(src=' + el + ', sizingMethod=scale)'"></li>
			<li class="add" ms-if="fileSrcList.length < max">
				<input type="file" multiple id="multi" />
				<span class="icon-add">✚</span>
			</li>
		</ul>
		<input type="submit" value="上传">
	</form>

	<div class="test">
		<h3>预览测试</h3>
		
		<div class="preview">
			
		</div>
	</div>
	<button ms-click="aaa">aaa</button>
	

	<script>
		var multi = document.getElementById('multi');

		var fileList = [];	// 存放file对象

		var model = avalon.define("test", function(vm) {
			vm.fileSrcList = [];
			vm.max = 4;
			vm.removeFile = function(index){
				model.fileSrcList.removeAt(index);
				fileList.splice(index, 1);
			};
			vm.aaa = function(){
				multi.click();
			};
		});

		multi.onchange = function(e){

			var files = this.files;
			
			if(files){	// chrome, ff, ie10+
				for(var i = 0, len = files.length; i < len; i++){
					preViewImg(files[i]);
				}
			}else{		// ie9-
				model.fileSrcList.push(this.value.replace(/\\/g, '/'));
			}

			// 清空input，保证下次change事件的触发
			this.value = '';
			// ie10-下无法清空，借用form的reset方法
			if(this.value){
				var _tempForm = document.createElement('form'),
					_nextElement = this.nextSibling,
					_parentElement = this.nextSibling;

				// 取出并清空该input
				_tempForm.appendChild(this);
				_tempForm.reset();

				// 放回该input
				if(_nextElement){
					_nextElement.parentNode.insertBefore(this, _nextElement);
				}else{
					// 如果不存在后节点，通过父节点放回
					_parentElement.appendChild(this);
				}
			}
			alert(this.value);
		};

		function preViewImg(file){
			
			if(/image/.test(file.type)){
				
				var reader = new FileReader();
				reader.readAsDataURL(file);
				
				reader.onprogress = function(e){
/*					if(e.lengthComputable){
						console.log('ok: ' + e.loaded + '/' + e.total);
					}else{
						console.log('no ok.');
					}*/
				};
				reader.onload = function(){
					if(model.fileSrcList.length < model.max){
						model.fileSrcList.push(reader.result);
						fileList.push(file);
					}
				};
			}
		}

	</script>
</body>
</html>